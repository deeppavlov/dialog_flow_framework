
<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../_static/images/logo-dff.svg" rel="icon" type="image/svg+xml">
    <title>Context guide &#8212; dff 0.7.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=b77b6cac" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=dc072ff8"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/katex.min.js?v=48ec3933"></script>
    <script src="../_static/auto-render.min.js?v=8b9f325c"></script>
    <script src="../_static/katex_autorenderer.js?v=bebc588a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guides/context_guide';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Superset guide" href="superset_guide.html" />
    <link rel="prev" title="Basic Concepts" href="basic_conceptions.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo-simple.svg" class="logo__image only-light" alt="DFF logo (simple and nice)"/>
    <script>document.write(`<img src="../_static/logo-simple.svg" class="logo__image only-dark" alt="DFF logo (simple and nice)"/>`);</script>
  
  
    <p class="title logo__title">Dialog Flow Framework</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../get_started.html">
                        Getting started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../user_guides.html">
                        User guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../examples.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference.html">
                        API reference
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../development.html">
                        Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../community.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../about_us.html">
                        About us
                      </a>
                    </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://forum.deeppavlov.ai" title="DeepPavlov Forum" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/images/logo-deeppavlov.svg" class="icon-link-image" alt="DeepPavlov Forum"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://t.me/DeepPavlovDreamDiscussions" title="Telegram" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Telegram</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/deeppavlov/dialog_flow_framework" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../get_started.html">
                        Getting started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../user_guides.html">
                        User guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../examples.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference.html">
                        API reference
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links-2">
                    More
                </button>
                <ul id="pst-nav-more-links-2" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../development.html">
                        Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../community.html">
                        Community
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../about_us.html">
                        About us
                      </a>
                    </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://forum.deeppavlov.ai" title="DeepPavlov Forum" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../_static/images/logo-deeppavlov.svg" class="icon-link-image" alt="DeepPavlov Forum"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://t.me/DeepPavlovDreamDiscussions" title="Telegram" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Telegram</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/deeppavlov/dialog_flow_framework" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="basic_conceptions.html">Basic Concepts</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Context guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="superset_guide.html">Superset guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization_guide.html">Optimization Guide</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../user_guides.html" class="nav-link">User guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Context guide</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="context-guide">
<h1>Context guide<a class="headerlink" href="#context-guide" title="Permalink to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Context</span></code> class is a backbone component of the DFF API.
Like the name suggests, this data structure is used to store information
about the current state, or context, of a particular conversation.
Each individual user has their own <code class="docutils literal notranslate"><span class="pre">Context</span></code> instance and can be identified by it.</p>
<p><code class="docutils literal notranslate"><span class="pre">Context</span></code> is used to keep track of the user’s requests, bot’s replies,
user-related and request-related annotations, and any other information
that is relevant to the conversation with the user.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since most callback functions used in DFF script and DFF pipeline (see the <a class="reference internal" href="basic_conceptions.html"><span class="doc">basic guide</span></a>)
need to either read or update the current dialog state,
the framework-level convention is that all functions of this kind
use <code class="docutils literal notranslate"><span class="pre">Context</span></code> as their first parameter. This dependency is being
injected by the pipeline during its run.
Thus, understanding the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class is essential for developing custom conversation logic
which is mostly made up by the said functions.</p>
</div>
<p>As a callback parameter, <code class="docutils literal notranslate"><span class="pre">Context</span></code> provides a convenient interface for working with data,
allowing developers to easily add, retrieve,
and manipulate data as the conversation progresses.</p>
<p>Let’s consider some of the built-in callback instances to see how the context can be leveraged:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>  <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[a-zA-Z]+&quot;</span><span class="p">)</span>
<span class="linenos">2</span>
<span class="linenos">3</span>  <span class="k">def</span> <span class="nf">regexp_condition_handler</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">4</span>      <span class="c1"># retrieve the current request</span>
<span class="linenos">5</span>      <span class="n">request</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">last_request</span>
<span class="linenos">6</span>      <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">7</span>          <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">8</span>      <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
<p>The code above is a condition function (see the <a class="reference internal" href="basic_conceptions.html"><span class="doc">basic guide</span></a>)
that belongs to the <code class="docutils literal notranslate"><span class="pre">TRANSITIONS</span></code> section of the script and returns <cite>True</cite> or <cite>False</cite>
depending on whether the current user request matches the given pattern.
As can be seen from the code block, the current
request (<code class="docutils literal notranslate"><span class="pre">last_request</span></code>) can be easily retrieved as one of the attributes of the <code class="docutils literal notranslate"><span class="pre">Context</span></code> object.
Likewise, the <code class="docutils literal notranslate"><span class="pre">last_response</span></code> (bot’s current reply) or the <code class="docutils literal notranslate"><span class="pre">last_label</span></code>
(the name of the currently visited node) attributes can be used in the same manner.</p>
<p>Another common use case is leveraging the <code class="docutils literal notranslate"><span class="pre">misc</span></code> field (see below for a detailed description):
pipeline functions or <code class="docutils literal notranslate"><span class="pre">PROCESSING</span></code> callbacks can write arbitrary values to the misc field,
making those available for other context-dependent functions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">def</span> <span class="nf">ping_example_com</span><span class="p">(</span>
<span class="linenos"> 5</span>    <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span>
<span class="linenos"> 6</span><span class="p">):</span>
<span class="linenos"> 7</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 8</span>        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s2">&quot;https://example.com/&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">webpage</span><span class="p">:</span>
<span class="linenos"> 9</span>            <span class="n">web_content</span> <span class="o">=</span> <span class="n">webpage</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<span class="linenos">10</span>                <span class="n">webpage</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get_content_charset</span><span class="p">()</span>
<span class="linenos">11</span>            <span class="p">)</span>
<span class="linenos">12</span>            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Example Domain&quot;</span> <span class="ow">in</span> <span class="n">web_content</span>
<span class="linenos">13</span>    <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">:</span>
<span class="linenos">14</span>        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">15</span>    <span class="n">ctx</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">&quot;can_ping_example_com&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this heading">#</a></h2>
<p>This sections describes the API of the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class.</p>
<p>For more information, such as method signatures, see
<a class="reference external" href="../apiref/dff.script.core.context.html#dff.script.core.context.Context">API reference</a>.</p>
<section id="attributes">
<h3>Attributes<a class="headerlink" href="#attributes" title="Permalink to this heading">#</a></h3>
<ul>
<li><p><strong>id</strong>: This attribute represents the unique context identifier. By default, it is randomly generated using uuid4.
In most cases, this attribute will be used to identify a user.</p></li>
<li><p><strong>labels</strong>: The labels attribute stores the history of all passed labels within the conversation.
It maps turn IDs to labels. The collection is ordered, so getting the last item of the mapping
always shows the last visited node.</p>
<p>Note that <cite>labels</cite> only stores the nodes that were transitioned to
so <cite>start_label</cite> will not be in this attribute.</p>
</li>
<li><p><strong>requests</strong>: The requests attribute maintains the history of all received requests by the agent.
It also maps turn IDs to requests. Like labels, it stores the requests in-order.</p></li>
<li><p><strong>responses</strong>: This attribute keeps a record of all agent responses, mapping turn IDs to responses.
Stores the responses in-order.</p></li>
<li><p><strong>misc</strong>: The misc attribute is a dictionary for storing custom data. This field is not used by any of the
built-in DFF classes or functions, so the values that you write there are guaranteed to persist
throughout the lifetime of the <code class="docutils literal notranslate"><span class="pre">Context</span></code> object.</p></li>
<li><p><strong>framework_states</strong>: This attribute is used for storing addon or pipeline states.
Each turn, the DFF pipeline records the intermediary states of its components into this field,
and clears it at the end of the turn. For this reason, developers are discouraged from storing
their own data in this field.</p></li>
</ul>
</section>
<section id="methods">
<h3>Methods<a class="headerlink" href="#methods" title="Permalink to this heading">#</a></h3>
<p>The methods of the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class can be divided into two categories:</p>
<ul class="simple">
<li><p>Public methods that get called manually in custom callbacks and in functions that depend on the context.</p></li>
<li><p>Methods that are not designed for manual calls and get called automatically during pipeline runs,
i.e. quasi-private methods. You may still need them when developing extensions or heavily modifying DFF.</p></li>
</ul>
<section id="public-methods">
<h4>Public methods<a class="headerlink" href="#public-methods" title="Permalink to this heading">#</a></h4>
<ul>
<li><p><strong>last_request</strong>: Return the last request of the context, or <cite>None</cite> if the <code class="docutils literal notranslate"><span class="pre">requests</span></code> field is empty.</p>
<p>Note that a request is added right after the context is created/retrieved from db,
so an empty <code class="docutils literal notranslate"><span class="pre">requests</span></code> field usually indicates an issue with the messenger interface.</p>
</li>
<li><p><strong>last_response</strong>: Return the last response of the context, or <cite>None</cite> if the <code class="docutils literal notranslate"><span class="pre">responses</span></code> field is empty.</p>
<p>Responses are added at the end of each turn, so an empty <code class="docutils literal notranslate"><span class="pre">response</span></code> field is something you should definitely consider.</p>
</li>
<li><p><strong>last_label</strong>: Return the last label of the context, or <cite>None</cite> if the <code class="docutils literal notranslate"><span class="pre">labels</span></code> field is empty.
Last label is always the name of the current node but not vice versa:</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">start_label</span></code> is not added to the <code class="docutils literal notranslate"><span class="pre">labels</span></code> field,
empty <code class="docutils literal notranslate"><span class="pre">labels</span></code> usually indicates that the current node is the <cite>start_node</cite>.
After a transition is made from the <cite>start_node</cite>
the label of that transition is added to the field.</p>
</li>
<li><p><strong>clear</strong>: Clear all items from context fields, optionally keeping the data from <cite>hold_last_n_indices</cite> turns.
You can specify which fields to clear using the <cite>field_names</cite> parameter. This method is designed for cases
when contexts are shared over high latency networks.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a class="reference external" href="../tutorials/tutorials.script.core.7_pre_response_processing.py">preprocessing tutorial</a>.</p>
</div>
</section>
<section id="private-methods">
<h4>Private methods<a class="headerlink" href="#private-methods" title="Permalink to this heading">#</a></h4>
<ul>
<li><p><strong>set_last_response, set_last_request</strong>: These methods allow you to set the last response or request for the current context.
This functionality can prove useful if you want to create a middleware component that overrides the pipeline functionality.</p></li>
<li><p><strong>add_request</strong>: Add a request to the context.
It updates the <cite>requests</cite> dictionary. This method is called by the <cite>Pipeline</cite> component
before any of the <a class="reference internal" href="../tutorials/tutorials.pipeline.3_pipeline_dict_with_services_basic.html"><span class="doc">pipeline services</span></a> are executed,
including <a class="reference external" href="../apiref/dff.pipeline.pipeline.actor.html">Actor</a>.</p></li>
<li><p><strong>add_response</strong>: Add a response to the context.
It updates the <cite>responses</cite> dictionary. This function is run by the <a class="reference external" href="../apiref/dff.pipeline.pipeline.actor.html">Actor</a> pipeline component at the end of the turn, after it has run
the <a class="reference external" href="../tutorials/tutorials.script.core.7_pre_response_processing.py">PRE_RESPONSE_PROCESSING</a> functions.</p>
<p>To be more precise, this method is called between the <code class="docutils literal notranslate"><span class="pre">CREATE_RESPONSE</span></code> and <code class="docutils literal notranslate"><span class="pre">FINISH_TURN</span></code> stages.
For more information about stages, see <a class="reference external" href="../apiref/dff.script.core.types.html#dff.script.core.types.ActorStage">ActorStages</a>.</p>
</li>
<li><p><strong>add_label</strong>: Add a label to the context.
It updates the <cite>labels</cite> field. This method is called by the <a class="reference external" href="../apiref/dff.pipeline.pipeline.actor.html">Actor</a> component when transition conditions
have been resolved, and when <a class="reference external" href="../tutorials/tutorials.script.core.9_pre_transitions_processing.py">PRE_TRANSITIONS_PROCESSING</a> callbacks have been run.</p>
<p>To be more precise, this method is called between the <code class="docutils literal notranslate"><span class="pre">GET_NEXT_NODE</span></code> and <code class="docutils literal notranslate"><span class="pre">REWRITE_NEXT_NODE</span></code> stages.
For more information about stages, see <a class="reference external" href="../apiref/dff.script.core.types.html#dff.script.core.types.ActorStage">ActorStages</a>.</p>
</li>
<li><p><strong>current_node</strong>: Return the current node of the context. This is particularly useful for tracking the node during the conversation flow.
This method only returns a node inside <code class="docutils literal notranslate"><span class="pre">PROCESSING</span></code> callbacks yielding <code class="docutils literal notranslate"><span class="pre">None</span></code> in other contexts.</p></li>
</ul>
</section>
</section>
</section>
<section id="context-storages">
<h2>Context storages<a class="headerlink" href="#context-storages" title="Permalink to this heading">#</a></h2>
<p>Since context instances contain all the information, relevant for a particular user, there needs to be a way
to persistently store that information and to make it accessible in different user sessions.
This functionality is implemented by the <code class="docutils literal notranslate"><span class="pre">context</span> <span class="pre">storages</span></code> module that provides
the uniform <code class="docutils literal notranslate"><span class="pre">DBContextStorage</span></code> interface as well as child classes thereof that integrate
various database types (see the
<a class="reference external" href="../apiref/dff.context_storages.database.html#dff.context_storages.database.DBContextStorage">api reference</a>).</p>
<p>The supported storage options are as follows:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.json.org/json-en.html">JSON</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/pickle.html">pickle</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/shelve.html">shelve</a></p></li>
<li><p><a class="reference external" href="https://www.sqlite.org/index.html">SQLite</a></p></li>
<li><p><a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a></p></li>
<li><p><a class="reference external" href="https://www.mysql.com/">MySQL</a></p></li>
<li><p><a class="reference external" href="https://www.mongodb.com/">MongoDB</a></p></li>
<li><p><a class="reference external" href="https://redis.io/">Redis</a></p></li>
<li><p><a class="reference external" href="https://ydb.tech/">Yandex DataBase</a></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">DBContextStorage</span></code> instances can be uniformly constructed using the <code class="docutils literal notranslate"><span class="pre">context_storage_factory</span></code> function.
The function’s only parameter is a connection string that specifies both the database type
and the connection parameters, for example, <em>mongodb://admin:pass&#64;localhost:27016/admin</em>.
(<a class="reference external" href="../apiref/dff.context_storages.database.html#dff.context_storages.database.context_storage_factory">see the reference</a>)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To learn how to use <code class="docutils literal notranslate"><span class="pre">context_storage_factory</span></code> in your pipeline, see our <a class="reference external" href="../tutorials/index_context_storages.html">Context Storage Tutorials</a>.</p>
</div>
<p>The GitHub-based distribution of DFF includes Docker images for each of the supported database types.
Therefore, the easiest way to deploy your service together with a database is to clone the GitHub
distribution and to take advantage of the packaged
<a class="reference external" href="https://github.com/deeppavlov/dialog_flow_framework/blob/master/compose.yml">docker compose file</a>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/deeppavlov/dialog_flow_framework.git
<span class="linenos">2</span><span class="nb">cd</span><span class="w"> </span>dialog_flow_framework
<span class="linenos">3</span><span class="c1"># assuming we need to deploy mongodb</span>
<span class="linenos">4</span>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>mongo
</pre></div>
</div>
<p>The images can be configured using the docker compose file or the
<a class="reference external" href="https://github.com/deeppavlov/dialog_flow_framework/blob/master/.env_file">environment file</a>,
also available in the distribution. Consult these files for more options.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The data transmission protocols require the data to be JSON-serializable. DFF tackles this problem
through utilization of <code class="docutils literal notranslate"><span class="pre">pydantic</span></code> as described in the next section.</p>
</div>
</section>
<section id="serialization">
<h2>Serialization<a class="headerlink" href="#serialization" title="Permalink to this heading">#</a></h2>
<p>The fact that the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class is a Pydantic model makes it easily convertible to other data formats,
such as JSON. For instance, as a developer, you don’t need to implement instructions on how datetime fields
need to be marshalled, since this functionality is provided by Pydantic out of the box.
As a result, working with web interfaces and databases that require the transmitted data to be serialized
becomes as easy as calling the <cite>model_dump_json</cite> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
<span class="n">serialized_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">()</span>
</pre></div>
</div>
<p>Knowing that, you can easily extend DFF to work with storages like Memcache or web APIs of your liking.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="basic_conceptions.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Basic Concepts</p>
      </div>
    </a>
    <a class="right-next"
       href="superset_guide.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Superset guide</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">

  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api">API</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#attributes">Attributes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#public-methods">Public methods</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#private-methods">Private methods</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#context-storages">Context storages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#serialization">Serialization</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, DeepPavlov.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>